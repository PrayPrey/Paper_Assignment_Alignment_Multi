# %%
import streamlit as st
from langgraph.graph import StateGraph
from typing import TypedDict, Literal
import fitz  # PyMuPDF
from docx import Document
import tempfile
from openai import OpenAI
from docx.shared import Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
from typing_extensions import Annotated  # Python 3.9+ or install via pip

# ======= PROMPTS =======
summarizer_prompt = """
ë‹¹ì‹ ì€ AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì„œ(ë˜ëŠ” ë…¼ë¬¸)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ë‹¤ë¥¸ AI ì „ë¬¸ê°€ê°€ í•µì‹¬ì„ ë¹ ë¥´ê²Œ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ **êµ¬ì¡°í™”ëœ ìš”ì•½**ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì•„ë˜ 4ê°œì˜ í•­ëª©ì— ëŒ€í•´ ë°˜ë“œì‹œ ì‘ì„±í•˜ë˜, ê° í•­ëª©ì€ **Subsection ì œëª© + Bullet í˜•ì‹**ìœ¼ë¡œ êµ¬ì„±í•´ì£¼ì„¸ìš”.  
íŠ¹íˆ **motivation, research gap, contributions, methodology overview, step-by-step method, experiment summary** ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.  
ê° **Subsetsion**ì—ëŠ” ìµœì†Œ 5 ë¬¸ì¥ì˜ ë‚´ìš©ì´ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤.

---

(1) **ê°œìš” (Introduction / Background)**  
- í•µì‹¬ Subsections:
    - ğŸ“Œ *Motivation* (ì™œ ì´ ì—°êµ¬ê°€ í•„ìš”í•œê°€?)  
    - ğŸ“Œ *Research Gap* (ê¸°ì¡´ ì—°êµ¬ì™€ì˜ ì°¨ë³„ì„±ì€?)  
    - ğŸ“Œ *Contributions* (ë…¼ë¬¸ì˜ ì£¼ìš” ê¸°ì—¬ëŠ”?)  
    - ğŸ“Œ *Related Works* (ì°¸ê³  ë¬¸í—Œê³¼ì˜ ì§ì ‘ì ì¸ ì—°ê²° ì¤‘ì‹¬ â€” ì–´ë–¤ ì—°êµ¬ì˜ ì–´ë–¤ ë‚´ìš©ì„ ê³„ìŠ¹/ì°¨ë³„í™”í–ˆëŠ”ê°€?)  
- ê° í•­ëª©ì€ **Bullet List**ë¡œ ì‘ì„±  
- ê¸°ìˆ  ìš©ì–´ëŠ” ë°˜ë“œì‹œ (ê´„í˜¸ ì•ˆì— ê°„ë‹¨íˆ í•´ì„¤) í¬í•¨

(2) **ë°©ë²•ë¡  (Methodology)**  
- í•µì‹¬ Subsections:
    - âš™ï¸ *Overview*: ì „ì²´ êµ¬ì¡° ìš”ì•½  
    - âš™ï¸ *Components*: ì£¼ìš” êµ¬ì„± ìš”ì†Œ ë° ì•Œê³ ë¦¬ì¦˜  
    - âš™ï¸ *Step-by-Step*: ë°©ë²•ë¡ ì˜ ì‹¤í–‰ ë‹¨ê³„  
    - âš™ï¸ *Differences*: ê¸°ì¡´ ê¸°ë²• ëŒ€ë¹„ êµ¬ì¡°ì  ì°¨ì´  
- ê°€ëŠ¥í•œ ê²½ìš° ìˆ˜ì‹ì´ë‚˜ ì•„í‚¤í…ì²˜ë¥¼ ì–¸ì–´ë¡œ ì„¤ëª…  
- **ê° Subsectionì€ Bullet í˜•ì‹ìœ¼ë¡œ ì •ë¦¬**

(3) **ì¥ì  ë° íš¨ê³¼ (Advantages and Impacts)**  
- í•µì‹¬ Subsections:
    - âœ… *Technical Benefits* (ì •í™•ë„, ì†ë„, í™•ì¥ì„± ë“±)  
    - âœ… *Practical Use Cases* (ì‹¤ì œ ì‚°ì—… ì ìš© ê°€ëŠ¥ì„±ì„ ì¤‘ì‹¬ìœ¼ë¡œ â€” í˜„ì¬ ê¸°ìˆ  íŠ¸ë Œë“œë‚˜ ì‚°ì—… ë¶„ì•¼ì™€ ì—°ê²°)  
    - âœ… *Expected Impact* (ê³¼ì œë‚˜ ì—…ë¬´ ìˆ˜í–‰ ì‹œ ê¸°ëŒ€ íš¨ê³¼, ì‚°ì—…ì  ë˜ëŠ” ì‚¬íšŒì  ê°€ì¹˜ í¬í•¨)  
    - âœ… *Evaluation Summary* (ì‚¬ìš©í•œ ì£¼ìš” metricê³¼ ê·¸ ê²°ê³¼ â€” ì˜ˆ: í‰ê·  ì‘ë‹µ ì†ë„ 20% í–¥ìƒ, RMSE 15% ê°ì†Œ ë“± **ìˆ«ì í¬í•¨ ê°„ê²°í•œ ìš”ì•½**)  
    - âœ… *Limitations* (ì•Œë ¤ì§„ í•œê³„ë‚˜ ê³ ë ¤ì‚¬í•­)  
- ê° í•­ëª©ì€ Bulletë¡œ ì§§ê³  ëª…í™•í•˜ê²Œ ì •ë¦¬

(4) **ì˜ˆìƒ ì§ˆë¬¸ ë° ì •ë‹µ (Q&A / FAQ)**  
- ê¸°ìˆ ì„ ì²˜ìŒ ì ‘í•˜ëŠ” ì „ë¬¸ê°€ë“¤ì´ ê°€ì§ˆ ë²•í•œ ì§ˆë¬¸ì„ 3~5ê°œ ìƒì •  
- ê° ì§ˆë¬¸ì€ â“ ë¡œ ì‹œì‘, ë‹µë³€ì€ â¤ ë¡œ ì‹œì‘  
- ì˜ˆì‹œ:
    - â“ ì´ ë°©ë²•ì´ ê¸°ì¡´ì— ì§„í–‰ë˜ì—ˆë˜ ì—°êµ¬ë“¤ë³´ë‹¤ ì •í™•í•œ ì´ìœ ëŠ”?
    - â¤ ê¸°ì¡´ ì—°êµ¬ë“¤ì€ [...]ì´ ë¶€ì¡±í–ˆì§€ë§Œ, ë³¸ ì—°êµ¬ëŠ” [...]ë¥¼ ê°œì„ í•¨.

---

**ì‘ì„± ì§€ì¹¨**  
- ê° í•­ëª©ì€ ë°˜ë“œì‹œ (1), (2), (3), (4) í˜•ì‹ìœ¼ë¡œ êµ¬ë¶„  
- ëª¨ë“  ê¸°ìˆ  ìš©ì–´ëŠ” (ê´„í˜¸ ì•ˆì— ê°„ë‹¨íˆ í•´ì„¤) ì¶”ê°€  
- ì „ì²´ ê¸¸ì´ëŠ” 18000ì ì´ë‚´  
- ì°¸ê³  ë¬¸í—Œì€ ê´€ë ¨ ë…¼ë¬¸ì„ í¬í•¨í•˜ì—¬ **APA í˜•ì‹**ìœ¼ë¡œ ë§¨ ì•„ë˜ ì •ë¦¬  
- ì°¸ê³  ë¬¸í—Œì€ **ê°€ëŠ¥í•˜ë©´ 7ê°œ ì´ìƒ**, ë‹¤ì–‘í•œ ë¶„ì•¼ì—ì„œ ê´€ë ¨ ì—°êµ¬ë¥¼ í­ë„“ê²Œ ì œì‹œí•´ì¤˜.  
- ì´ ê²°ê³¼ëŠ” â€œì¼ë°˜ì¸ìš© ì„¤ëª…â€ ìƒì„±ì„ ìœ„í•œ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
"""


expander_prompt = """
ë‹¤ìŒì€ í•œ ë…¼ë¬¸ì˜ ì›ë¬¸, í•´ë‹¹ ë…¼ë¬¸ì„ ìš”ì•½í•œ ì „ë¬¸ê°€ìš© í•´ì„¤, ê·¸ë¦¬ê³  ì´ ë‚´ìš©ì„ ì°¸ê³ í•´ì•¼ í•  ê³¼ì œì˜ ëª©ì ì´ì•¼.

ë‹¹ì‹ ì˜ ì—­í• ì€ ê¸°ìˆ ì„ ì‰½ê²Œ í’€ì–´ ì„¤ëª…í•˜ëŠ” ê²ƒë¿ ì•„ë‹ˆë¼,  
**"ì´ ê¸°ìˆ ì´ ì‹¤ì œë¡œ í•´ë‹¹ ê³¼ì œë¥¼ í•´ê²°í•˜ëŠ” ë° ì‹¤ì§ˆì ì¸ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ”ê°€?"ë¥¼ ë¨¼ì € íŒë‹¨**í•˜ê³ ,  
ê·¸ íŒë‹¨ì— ê·¼ê±°í•´ ì¼ë°˜ì¸ì´ ì´í•´í•˜ê¸° ì‰¬ìš´ ì„¤ëª…ì„ ì‘ì„±í•˜ëŠ” ê²ƒì´ì•¼.

ë”°ë¼ì„œ ì„¤ëª…ì€ ë‹¨ìˆœíˆ ë‚´ìš©ì„ ì‰½ê²Œ í’€ì–´ë‚´ëŠ” ê²ƒì„ ë„˜ì–´ì„œ,  
**"ì™œ ì´ ê¸°ìˆ ì´ ì´ ê³¼ì œì— ì˜ë¯¸ ìˆê³  ì“¸ëª¨ ìˆëŠ”ì§€"ë¥¼ ë…ìê°€ ìì—°ìŠ¤ëŸ½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±**í•´ì•¼ í•´.

---

(1) **ê°œìš”**  
   - ì–´ë ¤ìš´ ê°œë…ì´ë‚˜ ìš©ì–´ëŠ” í’€ì–´ì„œ ì„¤ëª…í•˜ê³ , ê°€ëŠ¥í•œ í•œ ë¹„ìœ ë‚˜ ì‚¬ë¡€ë¥¼ í™œìš©í•´ì¤˜.  
   - ë°°ê²½ë³´ë‹¤ëŠ” â€œì´ê²Œ ì™œ ì¤‘ìš”í•œì§€â€ì™€ â€œë¬´ì—‡ì„ ê°€ëŠ¥í•˜ê²Œ í•´ì£¼ëŠ”ì§€â€ì— ë” ì§‘ì¤‘í•´ì¤˜.  
   - íŠ¹íˆ, **ì´ ê¸°ìˆ ì´ ê³¼ì œ ëª©ì ê³¼ ì‹¤ì œë¡œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì—°ê²°ë˜ëŠ”ì§€ë¥¼ ì„¤ëª…í•´ì¤˜**.  
     ì—°ê²°ì´ ì•½í•˜ë‹¤ë©´ ê·¸ ì´ìœ ë„ í•¨ê»˜ ì–¸ê¸‰í•˜ê³ , ê°€ëŠ¥í•œ ëŒ€ì•ˆì  ê¸°ìˆ ë„ ì œì•ˆí•´ì¤˜.  
   - ê¸°ìˆ ì ì¸ í•µì‹¬ë„ ë¹ ëœ¨ë¦¬ì§€ ë§ê³  ê°„ë‹¨í•˜ê²Œë¼ë„ êµ¬ì¡°ì  ë°©ì‹(ì˜ˆ: "ë°ì´í„°ë¥¼ ì´ë ‡ê²Œ ì²˜ë¦¬í•˜ê³ , ì´ë ‡ê²Œ ê²°í•©í•œë‹¤" ì‹)ì„ ë„£ì–´ì¤˜.  
   - íŠ¹íˆ "ë°©ë²•ë¡ "ì˜ í•µì‹¬ ì•„ì´ë””ì–´ê°€ ë¹ ì§€ì§€ ì•Šë„ë¡ í•´ì¤˜. ê·¸ë˜ì•¼ ë…ìê°€ 'ì´ê±´ ê¸°ìˆ ì ìœ¼ë¡œ ìƒˆë¡œìš´ ë°©ì‹ì´êµ¬ë‚˜'ë¼ëŠ” ëŠë‚Œì„ ë°›ì„ ìˆ˜ ìˆì–´.

(2) **ì¥ì  ë° íš¨ê³¼**  
   - ì´ ê¸°ìˆ ì´ ì–´ë–¤ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í•˜ëŠ”ì§€, ê·¸ë¦¬ê³  ê·¸ê²Œ ì™œ ìœ ìš©í•œì§€ë¥¼ ì‹¤ìƒí™œì´ë‚˜ ê³¼ì œ/ì—…ë¬´ ê´€ì ì—ì„œ í’€ì–´ì¤˜.  
   - ì‚¬ëŒë“¤ì´ ì‹¤ì œë¡œ **ì´ ê¸°ìˆ ì„ ì–´ë””ì— ì“¸ ìˆ˜ ìˆëŠ”ì§€, ì–´ë–¤ ê²°ê³¼ë¥¼ ê¸°ëŒ€í•  ìˆ˜ ìˆëŠ”ì§€**ì— ì´ˆì ì„ ë§ì¶° ì„¤ëª…í•´ì¤˜.  
   - íŠ¹íˆ, **ê³¼ì œì—ì„œ í•´ê²°í•˜ë ¤ëŠ” ë¬¸ì œì™€ ì´ ê¸°ìˆ ì´ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€ë¥¼ ëª…í™•íˆ í‘œí˜„í•´ì¤˜.**  
     ì§ì ‘ì ì¸ ê¸°ì—¬ê°€ ì–´ë ¤ìš¸ ê²½ìš°, ê°„ì ‘ì ì¸ ì—°ê´€ ê°€ëŠ¥ì„±ì´ë‚˜ ê³ ë ¤í•  ì ë„ í•¨ê»˜ ì–¸ê¸‰í•´ì¤˜.  
   - ì„¤ëª…ì´ ë„ˆë¬´ ì¼ë°˜ì ì´ì§€ ì•Šë„ë¡, ê¸°ìˆ ì ì¸ í•µì‹¬ì„ ê°„ë‹¨í•˜ê²Œë¼ë„ ì„¤ëª…í•´ì¤˜ (ì˜ˆ: "ë°ì´í„°ë¥¼ ì´ë ‡ê²Œ ì²˜ë¦¬í•˜ê³ , ì´ë ‡ê²Œ ê²°í•©í•œë‹¤").  
   - "ë°©ë²•ë¡ "ì´ ë‹¨ì§€ ì¡´ì¬í•œë‹¤ê³ ë§Œ í•˜ì§€ ë§ê³ , ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë‹¤ë¥´ê³  ì™œ ê·¸ê²Œ íš¨ê³¼ì ì¸ì§€ë„ í‘œí˜„í•´ì¤˜.

(3) **ì˜ˆìƒ ì§ˆë¬¸ ë° ì •ë‹µ**  
   - ê¸°ìˆ ì— ëŒ€í•´ ì¼ë°˜ì¸ì´ ê°€ì§ˆ ìˆ˜ ìˆëŠ” í˜„ì‹¤ì ì¸ ì˜ë¬¸ì„ ìƒì •í•˜ê³ , ìµœëŒ€í•œ ì‰½ê²Œ, êµ¬ì²´ì ìœ¼ë¡œ ë‹µë³€í•´ì¤˜.  
   - ê¸°ìˆ ì ì¸ ì„¤ëª…ë³´ë‹¤ëŠ” â€œì´ê²Œ ë‚˜í•œí…Œ ì–´ë–¤ ì˜ë¯¸ê°€ ìˆì§€?â€ë¥¼ í•´ì†Œí•´ì£¼ëŠ” ì‹ì´ë©´ ì¢‹ì•„.  
   - ê³¼ì œ ìˆ˜í–‰ ì¤‘ ìƒê¸¸ ìˆ˜ ìˆëŠ” **ê¸°ìˆ  ì ìš©ì˜ í˜„ì‹¤ì ì¸ ê±±ì •ì´ë‚˜ ë¶ˆí™•ì‹¤ì„±**ë„ ì§ˆë¬¸ìœ¼ë¡œ í¬í•¨í•´ì¤˜.  
   - ì•ì„œ ì„¤ëª…í•œ ì¥ì ê³¼ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡, ì§ˆë¬¸ì€ ì£¼ë¡œ ê¸°ìˆ  ì ìš© ì‹œì˜ í˜„ì‹¤ì  ì˜ë¬¸ ìœ„ì£¼ë¡œ ì‘ì„±í•´ì¤˜.

**í˜•ì‹ ì¡°ê±´**  
- í•­ëª© êµ¬ì¡°ëŠ” ë°˜ë“œì‹œ (1), (2), (3) í˜•ì‹ì„ í¬í•¨í•˜ê³ , ìœ ì§€í•  ê²ƒ  
- ì „ì²´ ê¸¸ì´ëŠ” 10000ì ì´ë‚´  
- í‘œí˜„ì€ ì‰½ê³  ì¹œê·¼í•˜ê²Œ, í•µì‹¬ì€ ë¹ ì§ì—†ì´  
"""




critic_prompt = """
ë‹¤ìŒì€ ë…¼ë¬¸ì˜ ì›ë¬¸, ì „ë¬¸ê°€ ìš”ì•½, ì¼ë°˜ì¸ì„ ìœ„í•œ 2ì°¨ ì‰¬ìš´ ì„¤ëª…, ê·¸ë¦¬ê³  ì´ ë‚´ìš©ì„ ì°¸ê³ í•´ ì‘ì„±ëœ ê³¼ì œì˜ ëª©ì ì´ì•¼.

ë‹¹ì‹ ì˜ ì—­í• ì€ AI ì „ë¬¸ê°€ë¡œì„œ ë‹¤ìŒ ë‘ ë¬¸ì„œë¥¼ í‰ê°€í•´ì¤„ ì‚¬ëŒì´ì•¼:

1. ì „ë¬¸ê°€ë¥¼ ìœ„í•œ ìš”ì•½ (Summarizer)
2. ì¼ë°˜ì¸ì„ ìœ„í•œ ì„¤ëª… (Expander)

íŠ¹íˆ ì´ ë¬¸ì„œë“¤ì´ ë‹¨ìˆœíˆ ë‚´ìš©ì„ ì •ë¦¬í•œ ê²ƒì„ ë„˜ì–´ì„œ,  
**"ì´ ê¸°ìˆ ì´ ì‹¤ì œë¡œ ì´ ê³¼ì œë¥¼ í•´ê²°í•˜ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ”ê°€?"**  
ë¼ëŠ” ê´€ì ì—ì„œ í‰ê°€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•´.


---  

1) **ì „ë¬¸ê°€ ìš”ì•½ í‰ê°€ (Summarizer Evaluation)**  
- (1) ë¬¸ì„œì˜ í•µì‹¬ ë‚´ìš©ì„ ì¶©ì‹¤íˆ ìš”ì•½í–ˆëŠ”ê°€? (O/X)  
- (2) í˜•ì‹ ìš”êµ¬ì‚¬í•­(1, 2, 3, 4 êµ¬ì¡° ë° ë¶„ëŸ‰ ë“±)ì„ ì˜ ì§€ì¼°ëŠ”ê°€? (O/X)  
- (3) ì°¸ê³  ë¬¸í—Œì´ ì‹¤ì œ ì¡´ì¬í•˜ê±°ë‚˜ ë…¼ë¬¸ê³¼ ê´€ë ¨ì„±ì´ ë†’ì€ê°€? (O/X)  
- (4) ê³¼ì œ ëª©ì ì„ ê¸°ì¤€ìœ¼ë¡œ ë³´ì•˜ì„ ë•Œ, ìš”ì•½ëœ ê¸°ìˆ ì´ **ì‹¤ì œë¡œ ê³¼ì œ í•´ê²°ì— ì‚¬ìš©ë  ìˆ˜ ìˆê±°ë‚˜, ì ìš© ê°€ëŠ¥ì„±ì— ëŒ€í•œ êµ¬ì²´ì  ì—°ê²°ì´ ì¡´ì¬í•˜ëŠ”ê°€?** (O/X)  

â†’ ì´ í•­ëª©ì€ ë‹¨ìˆœíˆ â€œì–¸ê¸‰â€ì´ ì•„ë‹Œ, **ê¸°ìˆ ì´ ê³¼ì œì— ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ê¸°ì—¬í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ë‚©ë“í•  ìˆ˜ ìˆì–´ì•¼** Oë¥¼ ì¤„ ìˆ˜ ìˆì–´.

2) **ì¼ë°˜ì¸ìš© ì„¤ëª… í‰ê°€ (Expander Evaluation)**  
- (1) ì „ë¬¸ê°€ ìš”ì•½ì˜ í•µì‹¬ ë‚´ìš©ì„ ì˜ ë°˜ì˜í–ˆëŠ”ê°€? (O/X)  
- (2) í‘œí˜„ì´ ì¼ë°˜ì¸ì´ ì´í•´í•  ìˆ˜ ìˆì„ ì •ë„ë¡œ ì¶©ë¶„íˆ ì‰¬ìš´ê°€? (O/X)  
- (3) ì¤‘ìš”í•œ ê¸°ìˆ  í¬ì¸íŠ¸ë‚˜ íš¨ê³¼ê°€ ë¹ ì§€ì§€ ì•Šì•˜ëŠ”ê°€? (O/X)  
- (4) ì´ ì„¤ëª…ì„ ì½ì—ˆì„ ë•Œ, ì¼ë°˜ì¸ë„ **â€œì´ ê¸°ìˆ ì´ ê³¼ì œë¥¼ í•´ê²°í•˜ëŠ” ë° ì‹¤ì§ˆì ì¸ ë„ì›€ì´ ë˜ê² êµ¬ë‚˜â€ë¼ê³  ëŠë‚„ ìˆ˜ ìˆëŠ”ê°€?** (O/X)  

â†’ ê¸°ìˆ ì  ì„¤ëª…ë³´ë‹¤ ì¤‘ìš”í•œ ê±´, **ê³¼ì œ ëª©ì ì— ë¹„ì¶° ë´¤ì„ ë•Œ ì´ ê¸°ìˆ ì´ ì‹¤ì œë¡œ ì“¸ëª¨ ìˆì–´ ë³´ì´ëŠëƒ**ëŠ” ì ì´ì•¼.

3) **ê³¼ì œ ì •ë ¬ ë¶„ì„ í‰ê°€ (Project Alignment Evaluation)**
- (1) ê³¼ì œì˜ ê¸°ìˆ ì  íë¦„ì„ ì˜ ìš”ì•½í–ˆëŠ”ê°€? (O/X)
- (2) ë…¼ë¬¸ ë°©ë²•ë¡ ì´ ê¸°ì—¬í•  ìˆ˜ ìˆëŠ” ì§€ì ì„ ì‹¤ì œë¡œ ì œì‹œí–ˆëŠ”ê°€? (O/X)
- (3) íš¨ê³¼ì™€ í•œê³„ë¥¼ ê· í˜• ìˆê²Œ ì„¤ëª…í–ˆëŠ”ê°€? (O/X)

â†’ íŠ¹íˆ â€œì§„í–‰ ìƒí™©â€ê³¼ â€œë…¼ë¬¸ ê¸°ìˆ â€ ê°„ì˜ ì—°ê²°ì„±ì´ ë‚©ë“ë  ì •ë„ì—¬ì•¼ í•¨

---

ê° í•­ëª©ì— ëŒ€í•´ O/Xë¡œ í‰ê°€í•˜ê³ ,  
**ë¬¸ì œê°€ ìˆëŠ” ê²½ìš°ëŠ” ë°˜ë“œì‹œ ê·¸ ì´ìœ ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…**í•´ì£¼ì„¸ìš”.  
(ì˜ˆ: ì—°ê´€ì„± ë¶€ì¡±, ë…¼ë¦¬ ë¹„ì•½, ì„¤ëª… ë¶ˆì¶©ë¶„, ì ìš© ê°€ëŠ¥ì„± ëª¨í˜¸í•¨ ë“±)

**ë§ˆì§€ë§‰ ì¤„ì—ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”:**  
[ì™„ë£Œ] ë˜ëŠ” [ìˆ˜ì • í•„ìš”]
"""


project_aligner_prompt = """
ë‹¤ìŒì€ í•œ ë…¼ë¬¸ ì›ë¬¸, ì „ë¬¸ê°€ìš© ìš”ì•½, ê·¸ë¦¬ê³  í˜„ì¬ ê³¼ì œì˜ ëª©ì ê³¼ ê¸°ìˆ ì  ì§„í–‰ ìƒí™©ì´ë‹¤.

ë‹¹ì‹ ì€ AI ê¸°ìˆ  ì ìš© ì»¨ì„¤í„´íŠ¸ë‹¤. ì§€ê¸ˆì˜ ê³¼ì œ ì§„í–‰ íë¦„ê³¼ ì‹¤í—˜ ë°©í–¥ì„±ì„ ê³ ë ¤í–ˆì„ ë•Œ,  
**ì´ ë…¼ë¬¸ì´ ì œì•ˆí•˜ëŠ” ë°©ë²•ë¡ ì´ ê³¼ì œì—ì„œ ì–´ë–¤ ë¬¸ì œë¥¼ í•´ê²°í•˜ê±°ë‚˜ ë³´ì™„í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ë¶„ì„**í•´ì¤˜.

ì…ë ¥ëœ 'ê³¼ì œ ì§„í–‰ ìƒí™©'ì€ ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ì„ ë”°ë¥´ê³  ìˆì–´:
- [ì™„ë£Œëœ ë‹¨ê³„ (~MM/DD)] í˜•ì‹ì€ ì´ë¯¸ ìˆ˜í–‰í•œ ë‚´ìš©ì„ ì˜ë¯¸í•¨
- [ì˜ˆì •ëœ ë‹¨ê³„ (~MM/DD)] í˜•ì‹ì€ ì•ìœ¼ë¡œ ìˆ˜í–‰í•  ê³„íšì„
- ë”°ë¼ì„œ ê° ë‹¨ê³„ë¥¼ êµ¬ë¶„í•´ ë¶„ì„í•˜ê³ , ë…¼ë¬¸ ë°©ë²•ë¡ ì´ 'ì˜ˆì •ëœ ë‹¨ê³„'ì— ì–´ë–¤ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ”ì§€ íŠ¹íˆ ì¤‘ì ì ìœ¼ë¡œ ì–¸ê¸‰í•´ì¤˜.
- ì˜ˆì •ëœ ë‹¨ê³„ëŠ” ë¶„ì„ì˜ ì¤‘ì‹¬ì´ ë˜ë©°, ì´ ë‹¨ê³„ì—ì„œ ë…¼ë¬¸ ê¸°ìˆ ì´ **ì§ì ‘ì ìœ¼ë¡œ ê¸°ì—¬í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰**í•´ì•¼ í•´.

ğŸ“Œ ë‹¨, ê° ì˜ˆì •ëœ ë‹¨ê³„ì— ëŒ€í•´ ë…¼ë¬¸ ê¸°ìˆ ì´ **ì§ì ‘ì  ë˜ëŠ” ê°„ì ‘ì ìœ¼ë¡œ ê¸°ì—¬í•  ìˆ˜ ìˆëŠ”ì§€ ê°œë³„ì ìœ¼ë¡œ íŒë‹¨**í•´ì¤˜.  
ê¸°ì—¬ ê°€ëŠ¥ì„±ì´ ë‚®ê±°ë‚˜ ì—°ê´€ì´ ì ì€ ë‹¨ê³„ëŠ” **ë¶„ì„ì—ì„œ ì œì™¸í•˜ê³ **, ê·¸ ì´ìœ ë„ ê°„ë‹¨íˆ ì„¤ëª…í•´ì¤˜.  
ì–µì§€ë¡œ ì—°ê²°í•˜ì§€ ë§ê³ , **ì •ë§ ê¸°ì—¬ê°€ ì˜ˆìƒë˜ëŠ” ë¶€ë¶„ì—ë§Œ ì§‘ì¤‘**í•´ì¤˜.

ğŸ›‘ ë…¼ë¬¸ì´ ê³¼ì œì˜ íë¦„ê³¼ ë§ì§€ ì•Šê±°ë‚˜, í˜„ì¬ ì˜ˆì • ë‹¨ê³„ì—ì„œ **ê¸°ì—¬í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ ì—†ë‹¤ê³  íŒë‹¨ë˜ë©´**,  
ê·¸ ì´ìœ ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•˜ê³ , **ì–´ë–¤ ì¡°ê±´ì´ë‚˜ ì‹œì ì—ì„œ ë‹¤ì‹œ ê²€í† í•˜ë©´ ì¢‹ì„ì§€ë„ ì œì•ˆ**í•´ì¤˜.

- ë‹¨ìˆœí•œ ìš”ì•½ì´ ì•„ë‹ˆë¼, â€œì–´ë–¤ ì‹¤í—˜ ë‹¨ê³„ë‚˜ ê¸°ìˆ  íë¦„ì—ì„œ ì´ ë°©ë²•ë¡ ì´ ìœ ì˜ë¯¸í•˜ê²Œ ì‘ìš©í•  ìˆ˜ ìˆì„ì§€â€ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•´ì¤˜.
- í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ëª¨ë¸, ë°ì´í„° íë¦„, ì ìš©í•˜ë ¤ëŠ” ê¸°ìˆ ë“¤ê³¼ ë…¼ë¬¸ ì† ë°©ë²•ë¡ ì´ ì–´ë–»ê²Œ ì—°ê²°ë  ìˆ˜ ìˆëŠ”ì§€ë„ ì–¸ê¸‰í•´ì¤˜.

ì¶œë ¥ í˜•ì‹ì€ ë‹¤ìŒê³¼ ê°™ì•„:
1. ê³¼ì œ ê¸°ìˆ  íë¦„ ìš”ì•½
2. ë…¼ë¬¸ ë°©ë²•ë¡ ì´ ê¸°ì—¬ ê°€ëŠ¥í•œ êµ¬ì²´ì  ì§€ì 
3. ì˜ˆìƒë˜ëŠ” ì ìš© íš¨ê³¼
4. í•œê³„ë‚˜ ê³ ë ¤ì‚¬í•­
"""

# âœ… ì „ì²´ ì •ë ¬ í‰ê°€ìš© í”„ë¡¬í”„íŠ¸ (í‘œ ìƒì„± í¬í•¨)
alignment_overview_prompt = """
ë‹¹ì‹ ì€ AI ê³¼ì œ ì„¤ê³„ ë° ê¸°ìˆ  ì ìš© ì „ëµê°€ì…ë‹ˆë‹¤.

ì•„ë˜ëŠ” í•˜ë‚˜ì˜ í”„ë¡œì íŠ¸ ëª©ì ê³¼ ì§„í–‰ ìƒí™©, ê·¸ë¦¬ê³  ì—¬ëŸ¬ ë…¼ë¬¸ì— ëŒ€í•´ ë¶„ì„ëœ ê³¼ì œ ì •ë ¬ í‰ê°€ ë‚´ìš©ì…ë‹ˆë‹¤.

ê° ë…¼ë¬¸ì´ ì´ ê³¼ì œì˜ í˜„ì¬ íë¦„ê³¼ ì–¼ë§ˆë‚˜ ì˜ ë§ëŠ”ì§€, ë‹¤ìŒ ì •ë³´ë¥¼ í‘œ í˜•ì‹ìœ¼ë¡œ ì œê³µí•´ì£¼ì„¸ìš”:
1. ì ìš© ê°€ëŠ¥ì„± (ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ)
2. í•œ ì¤„ ìš”ì•½ (ì´ ë…¼ë¬¸ì´ ì–´ë–»ê²Œ ê¸°ì—¬í•  ìˆ˜ ìˆëŠ”ì§€)
3. í™œìš© ì¶”ì²œ ì‹œì  (ì˜ˆ: ë°ì´í„° ìˆ˜ì§‘ ë‹¨ê³„, ëª¨ë¸ í•™ìŠµ ë‹¨ê³„, QA ì‘ë‹µ ìƒì„± ë‹¨ê³„ ë“±)

í‘œ í˜•ì‹ ì˜ˆì‹œ:

| ë…¼ë¬¸ ì œëª© | ì ìš© ê°€ëŠ¥ì„± | í•œ ì¤„ ìš”ì•½ | í™œìš© ì¶”ì²œ ì‹œì  |
|-----------|--------------|-----------------------------|--------------------|
| ë…¼ë¬¸ A    | ë†’ìŒ âœ…     | ì‹¤í—˜ êµ¬ì¡°ì™€ ì •í™•ë„ í–¥ìƒì— ì§ì ‘ ê¸°ì—¬ ê°€ëŠ¥ | ëª¨ë¸ í•™ìŠµ ë‹¨ê³„ |
| ë…¼ë¬¸ B    | ë‚®ìŒ âŒ     | ê¸°ìˆ  íë¦„ ì°¨ì´ë¡œ ì¸í•´ ì§ì ‘ ì ìš© ì–´ë ¤ì›€ | í™œìš© ë¶ˆê°€ |

- í‘œ í˜•ì‹ì€ Markdown í…Œì´ë¸”ë¡œ ì¶œë ¥
- ì œëª©ì€ ì‹¤ì œ ë…¼ë¬¸ íŒŒì¼ëª… ë˜ëŠ” ë¬¸ì„œ ì œëª©ì„ í™œìš©
- í‘œí˜„ì€ ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ
- ë…¼ë¬¸ì´ ì“¸ëª¨ ì—†ë‹¤ë©´ ì´ìœ ì™€ í•¨ê»˜ 'í™œìš© ë¶ˆê°€'ë¡œ ëª…ì‹œ
"""

# chatgpt-4o-latest
# gpt-4o
# ======= AGENTS =======
def call_openai_gpt(prompt: str, model="chatgpt-4o-latest") -> str:
    client = OpenAI()
    response = client.chat.completions.create(
        model=model,
        messages=[
            {"role": "system", "content": "ë‹µë³€ì€ í‘œì¤€ì ì´ê³  ëª…í™•í•´ì•¼ í•˜ë©°, ì¼ë°˜ì¸ì´ ì´í•´í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.0,
    )
    return response.choices[0].message.content

def call_summarizer(document: str, feedback: str = "") -> str:
    prompt = summarizer_prompt
    if feedback:
        prompt += f"\n\n[Critic Feedback:\n{feedback}]\n"
    return call_openai_gpt(prompt + "\n\n" + document)

def call_expander(summary: str, document: str, project_goal: str, project_status: str) -> str:
    prompt = expander_prompt + f"""

===== ê³¼ì œ ëª©ì  =====
{project_goal}

===== ê³¼ì œ ì§„í–‰ ìƒí™© =====
{project_status if project_status.strip() else "ì§„í–‰ ìƒí™© ì •ë³´ ì—†ìŒ"}

===== ì›ë¬¸ =====
{document}

===== 1ì°¨ ìš”ì•½ =====
{summary}
"""
    return call_openai_gpt(prompt)

def call_critic(document: str, summary: str, expanded: str, project_goal: str, alignment: str):
    prompt = critic_prompt + f"""

===== ê³¼ì œ ëª©ì  =====
{project_goal}

===== ë…¼ë¬¸ ì›ë¬¸ =====
{document}

===== 1ì°¨ ìš”ì•½ =====
{summary}

===== 2ì°¨ ì„¤ëª… =====
{expanded}

===== ê³¼ì œ ì •ë ¬ ë¶„ì„ =====
{alignment}
"""
    result = call_openai_gpt(prompt)
    ...

    if "[ì™„ë£Œ]" in result:
        return result, "done", ""
    else:
        return result, "in_progress", result

        # "summary_pro_3line": summary_pro,
        # "summary_nonpro_3line": summary_nonpro,


def call_project_aligner(summary: str, document: str, project_goal: str, project_status: str) -> str:
    prompt = project_aligner_prompt + f"""

===== ê³¼ì œ ëª©ì  =====
{project_goal}

===== ê³¼ì œ ì§„í–‰ ìƒí™© =====
{project_status if project_status.strip() else "ì§„í–‰ ìƒí™© ì •ë³´ ì—†ìŒ"}

===== ë…¼ë¬¸ ìš”ì•½ =====
{summary}

===== ë…¼ë¬¸ ì›ë¬¸ =====
{document}
"""
    return call_openai_gpt(prompt)


# âœ… Agent í•¨ìˆ˜ ì •ì˜ (ì „ì²´ ì¢…í•© ë¶„ì„)
def call_alignment_overview_agent(project_goal: str, project_status: str, alignments: dict[str, str]) -> str:
    prompt = alignment_overview_prompt + f"""

===== ê³¼ì œ ëª©ì  =====
{project_goal}

===== ê³¼ì œ ì§„í–‰ ìƒí™© =====
{project_status}

===== ë…¼ë¬¸ë³„ ì •ë ¬ í‰ê°€ =====
""" + "\n\n".join([f"[{k}]\n{v}" for k, v in alignments.items()])

    return call_openai_gpt(prompt)


# ======= GRAPH =======
class State(TypedDict):
    document: Annotated[str, "static"]
    summary: str
    expanded_summary: str
    feedback: str
    status: Literal["in_progress", "done"]
    loop_count: int
    critic_result: str
    project_goal: str
    project_status: str  # âœ… ì¶”ê°€
    summary_pro_3line : str
    summary_nonpro_3line : str
    alignment_analysis: str  # ğŸ”¥ ìƒˆ í•„ë“œ

def summarizer_node(state):
    summary = call_summarizer(state["document"], state.get("feedback", ""))
    return {**state, "summary": summary}

def expander_node(state):
    expanded = call_expander(
        state["summary"],
        state["document"],
        state["project_goal"],
        state.get("project_status", "")
    )
    return {**state, "expanded_summary": expanded}

def project_aligner_node(state):
    result = call_project_aligner(
        state["summary"],
        state["document"],
        state["project_goal"],
        state["project_status"]
    )
    return {**state, "alignment_analysis": result}


def critic_node(state):
    result, status, feedback = call_critic(
        state["document"],
        state["summary"],
        state["expanded_summary"],
        state["project_goal"],
        state.get("alignment_analysis", "")  # âœ… ì´ ì¤„ì´ ê¼­ í•„ìš”í•´ìš”
    )
    return {
        **state,
        "critic_result": result,
        "feedback": feedback,
        "status": status,
        "loop_count": state["loop_count"] + 1
    }


def check_continue(state):
    if state["status"] == "done":
        return "final"  # 3ì¤„ ìš”ì•½ìœ¼ë¡œ ì´ë™
    elif state["loop_count"] < 5:
        return "continue"  # ë‹¤ì‹œ summarizerë¡œ ë£¨í”„
    else:
        return "exit"  # ìµœëŒ€ íšŸìˆ˜ ë„ë‹¬, ì¢…ë£Œ


def final_3line_summary_node(state):
    summary_pro = call_openai_gpt(
        f"""
        ë‹¹ì‹ ì€ AI ë…¼ë¬¸ ìš”ì•½ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

        ì•„ë˜ëŠ” ì–´ë–¤ ë…¼ë¬¸ì„ ì •ë¦¬í•œ ì „ë¬¸ê°€ìš© ìš”ì•½ì…ë‹ˆë‹¤.  
        ì´ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ, ë‹¤ìŒ 3ê°€ì§€ í•­ëª©ì— ëŒ€í•´ í•œ ì¤„ì”© ìš”ì•½í•´ì£¼ì„¸ìš”.

        1. ë¬¸ì œ ì •ì˜ì™€ ì œì•ˆëœ í•´ê²° ë°©ë²•  
        2. ì œì•ˆëœ ë°©ë²•ë¡ ì˜ í•µì‹¬ êµ¬ì¡°  
        3. ì£¼ìš” ì‹¤í—˜ ê²°ê³¼ ë˜ëŠ” ê¸°ëŒ€ íš¨ê³¼  

        ê° í•­ëª©ì€ ìµœì†Œ ì„¸ í•­ìœ¼ë¡œ ë„ì–´ì„œ ì•ì— '-' ì„ ë¶™ì—¬ì„œ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”.

        ===== ì „ë¬¸ê°€ ìš”ì•½ =====
        {state["summary"]}
        """
    )

    summary_nonpro = call_openai_gpt(
        f"""
        ë‹¹ì‹ ì€ ê¸°ìˆ  ë‚´ìš©ì„ ì¼ë°˜ì¸ë„ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì„¤ëª…í•˜ëŠ” AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

        ì•„ë˜ëŠ” ì–´ë–¤ ê¸°ìˆ ì— ëŒ€í•œ ì¼ë°˜ì¸ìš© ì‰¬ìš´ ì„¤ëª…ê³¼ ê³¼ì œ ëª©ì ì…ë‹ˆë‹¤.  
        ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, ë‹¤ìŒ 3ê°€ì§€ í•­ëª©ì„ ê°ê° í•œ ì¤„ì”© ì„¤ëª…í•´ì£¼ì„¸ìš”:

        1. ì´ ê¸°ìˆ ì´ ì–´ë–¤ ë°©ì‹ì¸ì§€ (ì‰½ê²Œ í•µì‹¬ ìš”ì•½)  
        2. ì´ ê¸°ìˆ ì´ ê³¼ì œ ëª©ì ê³¼ ì–¼ë§ˆë‚˜ ì˜ ë§ëŠ”ì§€  
        3. ì´ ê¸°ìˆ ì„ ì ìš©í–ˆì„ ë•Œ ê¸°ëŒ€ë˜ëŠ” íš¨ê³¼  

        ê° í•­ëª©ì€ ë¹„ì „ê³µìê°€ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ê°„ê²°í•˜ê³  ì¹œê·¼í•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

        ===== ê³¼ì œ ëª©ì  =====
        {state["project_goal"]}

        ===== ì¼ë°˜ì¸ìš© ì„¤ëª… =====
        {state["expanded_summary"]}
        """
    )
    return {
        **state,
        "summary_pro_3line": summary_pro,
        "summary_nonpro_3line": summary_nonpro,
    }






def build_graph():
    builder = StateGraph(State)

    # ì£¼ìš” ë…¸ë“œ ë“±ë¡
    builder.add_node("summarizer", summarizer_node)
    builder.add_node("expander", expander_node)
    builder.add_node("critic", critic_node)
    builder.add_node("final_3line_summary", final_3line_summary_node)  # âœ… ì¶”ê°€
    builder.add_node("project_aligner", project_aligner_node)
    
    # ì‹œì‘ ì§€ì 
    builder.set_entry_point("summarizer")

    # ê¸°ë³¸ íë¦„
    builder.add_edge("summarizer", "expander")
    # íë¦„ ìˆœì„œ ë³€ê²½
    builder.add_edge("expander", "project_aligner")
    builder.add_edge("project_aligner", "critic")
    builder.add_edge("critic", "final_3line_summary")

    # critic ì¡°ê±´ ë¶„ê¸° â†’ ì™„ë£Œ ì‹œ final ìš”ì•½ ìƒì„±
    builder.add_conditional_edges("critic", check_continue, {
        "final": "final_3line_summary",
        "continue" : "summarizer",
        "exit": "__end__"  # âœ… ì¢…ë£Œ ì‹œ ë°˜ë“œì‹œ "__end__" ì‚¬ìš©
    })


    return builder.compile()


def extract_text_from_pdf(file) -> tuple[str, str]:
    text = ""
    with fitz.open(stream=file.read(), filetype="pdf") as doc:
        for page in doc:
            text += page.get_text()
    first_newline = text.find("\n")
    title = text[:first_newline].strip() if first_newline != -1 else "ì œëª© ì—†ìŒ"
    body = text[first_newline:].strip() if first_newline != -1 else text
    return title, body

def save_summary_to_word(summary: str, title: str) -> str:
    doc = Document()

    # ì œëª© ìŠ¤íƒ€ì¼
    title_para = doc.add_paragraph()
    run = title_para.add_run(title)
    run.font.size = Pt(16)
    run.bold = True
    run.font.color.rgb = RGBColor(0xC0, 0x00, 0x00)
    title_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
    title_para.add_run("\n" + "â€•" * 50)

    # ë³¸ë¬¸ ìŠ¤íƒ€ì¼
    style = doc.styles['Normal']
    font = style.font
    font.name = 'ë§‘ì€ ê³ ë”•'
    font.size = Pt(11)

    for line in summary.strip().split("\n"):
        if line.strip() == "":
            doc.add_paragraph("")
        elif line.startswith("1)") or line.startswith("2)") or line.startswith("3)"):
            para = doc.add_paragraph()
            run = para.add_run(line)
            run.bold = True
            run.font.color.rgb = RGBColor(0x2E, 0x74, 0xB5)
        else:
            doc.add_paragraph(line)

    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=".docx")
    doc.save(temp_file.name)
    return temp_file.name
# %%

